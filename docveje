```mermaid
flowchart TD
Start([ğŸš€ DÃ‰BUT EXÃ‰CUTION SCÃ‰NARIO]) â€“> LoadEnv[ğŸ“‹ Chargement Variables dâ€™Environnement]

%% Validation variables environnement
LoadEnv --> ValidateEnv{Variables obligatoires<br/>prÃ©sentes ?}
ValidateEnv -->|NON| ErrorEnv[âŒ ERREUR<br/>Variables manquantes<br/>EXIT CODE 2]

%% Chargement configuration fichier
ValidateEnv -->|OUI| LoadConfig[ğŸ“„ Chargement Configuration<br/>Fichier YAML]
LoadConfig --> ValidateConfig{Fichier configuration<br/>valide ?}
ValidateConfig -->|NON| ErrorConfig[âŒ ERREUR<br/>Configuration invalide<br/>EXIT CODE 2]

%% VÃ©rification mode lecture API
ValidateConfig -->|OUI| CheckLectureMode{LECTURE = true ?}

%% Mode hors ligne (LECTURE=false)
CheckLectureMode -->|NON| OfflineMode[ğŸ“´ Mode Hors Ligne<br/>Configuration fichier uniquement]
OfflineMode --> CreateDirs1[ğŸ“ CrÃ©ation RÃ©pertoires Sortie]

%% Mode en ligne (LECTURE=true)
CheckLectureMode -->|OUI| CallAPI[ğŸŒ Appel API ScÃ©nario]
CallAPI --> APISuccess{API accessible<br/>et donnÃ©es valides ?}

%% Erreur API
APISuccess -->|NON| HandleAPIError[âš ï¸ Gestion Erreur API]
HandleAPIError --> SaveUnknownStatus[ğŸ’¾ Sauvegarde Status UNKNOWN<br/>Type: Infrastructure]
SaveUnknownStatus --> ErrorAPI[âŒ ARRÃŠT<br/>Erreur Infrastructure<br/>EXIT CODE 3]

%% SuccÃ¨s API - VÃ©rification planning
APISuccess -->|OUI| MergeConfig[ğŸ”„ Fusion Configuration<br/>API + Fichier + Environnement]
MergeConfig --> CheckScheduling{VÃ©rification<br/>Planning d'ExÃ©cution}

%% VÃ©rification jours fÃ©riÃ©s
CheckScheduling --> IsHoliday{Jour fÃ©riÃ© ?}
IsHoliday -->|OUI| CheckHolidayFlag{flag_ferie = true ?}
CheckHolidayFlag -->|NON| ErrorHoliday[âŒ ARRÃŠT<br/>ExÃ©cution interdite<br/>les jours fÃ©riÃ©s<br/>EXIT CODE 2]

%% VÃ©rification plages horaires
IsHoliday -->|NON| CheckTimeSlots[â° VÃ©rification Plages Horaires]
CheckHolidayFlag -->|OUI| CheckTimeSlots

CheckTimeSlots --> InTimeSlot{Heure dans<br/>plage autorisÃ©e ?}
InTimeSlot -->|NON| ErrorTimeSlot[âŒ ARRÃŠT<br/>Heure hors planning<br/>EXIT CODE 2]

%% CrÃ©ation environnement d'exÃ©cution
InTimeSlot -->|OUI| CreateDirs2[ğŸ“ CrÃ©ation RÃ©pertoires Sortie]
CreateDirs1 --> LoadUsers
CreateDirs2 --> LoadUsers[ğŸ‘¤ Chargement Utilisateurs ISAC]

LoadUsers --> ValidateUsers{Utilisateurs<br/>valides ?}
ValidateUsers -->|NON| ErrorUsers[âŒ ERREUR<br/>Utilisateurs invalides<br/>EXIT CODE 2]

%% Lancement navigateur
ValidateUsers -->|OUI| LaunchBrowser[ğŸŒ Lancement Navigateur Playwright]
LaunchBrowser --> BrowserSuccess{Navigateur<br/>lancÃ© avec succÃ¨s ?}

BrowserSuccess -->|NON| ErrorBrowser[âŒ ERREUR<br/>Ã‰chec lancement navigateur<br/>EXIT CODE 2]

%% CrÃ©ation contexte et page
BrowserSuccess -->|OUI| CreateContext[ğŸ–¥ï¸ CrÃ©ation Contexte Navigateur<br/>+ Configuration Proxy/Cookies]
CreateContext --> CreatePage[ğŸ“„ CrÃ©ation Page Initiale]
CreatePage --> StartTracing[ğŸ“¹ DÃ©marrage Enregistrement Traces]

%% ExÃ©cution des Ã©tapes
StartTracing --> InitExecution[âš™ï¸ Initialisation ExÃ©cution<br/>Compteur Ã©tapes = 0]
InitExecution --> ExecuteSteps[ğŸ”„ Boucle d'ExÃ©cution des Ã‰tapes]

%% Traitement d'une Ã©tape
ExecuteSteps --> NextStep{Ã‰tape suivante<br/>disponible ?}
NextStep -->|NON| AllStepsComplete[âœ… Toutes les Ã‰tapes TerminÃ©es]

NextStep -->|OUI| IncrementCounter[ğŸ“Š IncrÃ©ment Compteur Ã‰tapes]
IncrementCounter --> ExecuteStep[âš¡ ExÃ©cution Ã‰tape Courante]

%% RÃ©sultat d'une Ã©tape
ExecuteStep --> StepResult{RÃ©sultat<br/>Ã©tape ?}

%% Ã‰tape en succÃ¨s
StepResult -->|SUCCÃˆS| StepSuccess[âœ… Ã‰tape RÃ©ussie<br/>Status = 0]
StepSuccess --> TakeScreenshot1[ğŸ“¸ Capture d'Ã‰cran Success]
TakeScreenshot1 --> LogStepSuccess[ğŸ“ Log Ã‰tape OK]
LogStepSuccess --> SaveStepResult1[ğŸ’¾ Sauvegarde RÃ©sultat Ã‰tape]
SaveStepResult1 --> ExecuteSteps

%% Ã‰tape en avertissement
StepResult -->|AVERTISSEMENT| StepWarning[âš ï¸ Ã‰tape avec Avertissement<br/>Status = 1]
StepWarning --> TakeScreenshot2[ğŸ“¸ Capture d'Ã‰cran Warning]
TakeScreenshot2 --> LogStepWarning[ğŸ“ Log Ã‰tape Warning]
LogStepWarning --> SaveStepResult2[ğŸ’¾ Sauvegarde RÃ©sultat Ã‰tape]
SaveStepResult2 --> ExecuteSteps

%% Ã‰tape en Ã©chec
StepResult -->|Ã‰CHEC| StepFailure[âŒ Ã‰tape en Ã‰chec<br/>Status = 2]
StepFailure --> AnalyzeError[ğŸ” Analyse de l'Erreur]

%% Types d'erreurs
AnalyzeError --> ErrorType{Type d'erreur ?}

%% Timeout avec vÃ©rification erreur applicative
ErrorType -->|TIMEOUT| CheckAppError[ğŸ” VÃ©rification Erreur Applicative<br/>dans la page HTML]
CheckAppError --> AppErrorFound{Erreur applicative<br/>dÃ©tectÃ©e ?}
AppErrorFound -->|OUI| LogAppError[ğŸ“ Log: Timeout dÃ» Ã  erreur applicative]
AppErrorFound -->|NON| LogTimeout[ğŸ“ Log: Timeout standard]
LogAppError --> TakeErrorScreenshot
LogTimeout --> TakeErrorScreenshot

%% Autres erreurs
ErrorType -->|NAVIGATION| LogNavError[ğŸ“ Log: Erreur de navigation]
ErrorType -->|ELEMENT| LogElementError[ğŸ“ Log: Ã‰lÃ©ment introuvable]
ErrorType -->|AUTRE| LogOtherError[ğŸ“ Log: Autre erreur]

LogNavError --> TakeErrorScreenshot[ğŸ“¸ Capture d'Ã‰cran Erreur]
LogElementError --> TakeErrorScreenshot
LogOtherError --> TakeErrorScreenshot

TakeErrorScreenshot --> SaveStepError[ğŸ’¾ Sauvegarde RÃ©sultat Erreur<br/>Status = 2]
SaveStepError --> StopOnError[ğŸ›‘ ArrÃªt ExÃ©cution sur Erreur<br/>EXIT CODE 2]

%% Finalisation succÃ¨s
AllStepsComplete --> CalculateResults[ğŸ“Š Calcul RÃ©sultats Finaux<br/>DurÃ©e, Statut Global, Stats]
CalculateResults --> StopTracing[ğŸ“¹ ArrÃªt Enregistrement Traces]
StopTracing --> SaveTraces[ğŸ’¾ Sauvegarde Traces RÃ©seau<br/>network_trace.zip]

SaveTraces --> GenerateReports[ğŸ“‹ GÃ©nÃ©ration Rapports]
GenerateReports --> SaveJSON[ğŸ’¾ Sauvegarde Rapport JSON<br/>scenario.json]

%% Inscription API (si activÃ©e)
SaveJSON --> CheckInscription{INSCRIPTION = true ?}
CheckInscription -->|NON| LogNoInscription[ğŸ“ Log: RÃ©sultats non inscrits]
CheckInscription -->|OUI| SendToAPI[ğŸŒ Envoi RÃ©sultats vers API]

SendToAPI --> APIInscriptionSuccess{Inscription API<br/>rÃ©ussie ?}
APIInscriptionSuccess -->|NON| LogAPIError[ğŸ“ Log: Erreur inscription API<br/>Mais continue...]
APIInscriptionSuccess -->|OUI| LogAPISuccess[ğŸ“ Log: Inscription API OK]

%% Nettoyage final
LogNoInscription --> CleanupResources[ğŸ§¹ Nettoyage Ressources]
LogAPIError --> CleanupResources
LogAPISuccess --> CleanupResources

CleanupResources --> CloseBrowser[ğŸ”’ Fermeture Navigateur]
CloseBrowser --> FinalSuccess[ğŸ¯ SUCCÃˆS COMPLET<br/>EXIT CODE 0]

%% Styling des noeuds
classDef successClass fill:#d4edda,stroke:#28a745,stroke-width:2px,color:#155724
classDef errorClass fill:#f8d7da,stroke:#dc3545,stroke-width:2px,color:#721c24
classDef warningClass fill:#fff3cd,stroke:#ffc107,stroke-width:2px,color:#856404
classDef processClass fill:#e2e3e5,stroke:#6c757d,stroke-width:2px,color:#495057
classDef decisionClass fill:#cce5ff,stroke:#007bff,stroke-width:2px,color:#004085
classDef apiClass fill:#e7f3ff,stroke:#0066cc,stroke-width:2px,color:#003d7a

%% Application des styles
class FinalSuccess,StepSuccess,LogAPISuccess,AllStepsComplete successClass
class ErrorEnv,ErrorConfig,ErrorAPI,ErrorHoliday,ErrorTimeSlot,ErrorUsers,ErrorBrowser,StepFailure,StopOnError errorClass
class StepWarning,SaveUnknownStatus,LogAPIError,LogNoInscription warningClass
class Start,LoadEnv,LoadConfig,CreateDirs1,CreateDirs2,LoadUsers,LaunchBrowser,CreateContext,CreatePage,StartTracing,InitExecution,ExecuteSteps processClass
class ValidateEnv,ValidateConfig,CheckLectureMode,APISuccess,IsHoliday,CheckHolidayFlag,InTimeSlot,ValidateUsers,BrowserSuccess,NextStep,StepResult,ErrorType,AppErrorFound,CheckInscription,APIInscriptionSuccess decisionClass
class CallAPI,MergeConfig,HandleAPIError,SendToAPI apiClass
```
